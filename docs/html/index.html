<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: ADC (CS1237) Library from Julian Weidinger</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">ADC (<a class="el" href="classCS1237.html" title="CS1237 class     The class is intended to configure and read the values of the ADC,...">CS1237</a>) Library from Julian Weidinger </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="intro_sec"></a>
Introduction</h1>
<p>As part of my bachelor thesis, I developed a device to measure the hardness differences in the snowpack. This can be attached to a ski touring probe. To take a measurement, the probe is inserted into the snow. The result is a hardness profile of the snowpack over the depth. The hardness measurement was carried out with the help of two load cells, two instrument amplifiers and two AD converters integrated in the microcontroller. Errors occurred because * the analog cables of the load cells were probably picking up electromagnetic interference. For this reason I selected an AD converter chip (<a class="el" href="classCS1237.html" title="CS1237 class     The class is intended to configure and read the values of the ADC,...">CS1237</a>) with an integrated amplifier and created a circuit board. The translated datasheet can be found <a href="https://github.com/rafaellcoellho/cs1237-datasheet/blob/master/cs1237_datasheet.pdf">here</a>. Every interface and timing information of the CS1237-Chip is taken out of this datasheet and isn't extra cited. The standard ADC-coverter (HX711) has a too slow sample rate, to use in my measurement device and the chips from other manufacturers ware too expensive. I wrote the following Arduino library as part of a study project "data communication" to create the digital interface between the ADC chip and the ESP32-microcontroller. breakoutboard for the ADC-chip was developed by myself, because I couldn't find a breakout to buy. In the following pictures you can see circuit diagram, the front and back schematic and a 3D-model of the breakoutboard: </p><div> <img src="..\images\circuit_diagram.png" alt="circuit_diagram couldn't be load!" style="width:22.3%;" title="Bildbeschreibung" class="inline"/> <img src="..\images\schematic_front.png" alt="schematic_front couldn't be load!" style="width:24%;" class="inline"/> <img src="..\images\schematic_back.png" alt="schematic_back couldn't be load!" style="width:24%;" class="inline"/> <img src="..\images\breakout_board_3D.png" alt="breakout_board_3D couldn't be load!" style="width:26.3%;" class="inline"/> </div><p> images of the circuit diagram, the front and back schematic and a 3D-model of the breakoutboard</p>
<h1><a class="anchor" id="describtion"></a>
Theme of the project</h1>
<p>The aim of the work is, to write a library, to configure the ADC and get the measured analog signal. The best solution would be an interrupt driven library, where you can connect two ADCs to the MCU and read it parralell in the background. Another nice feature would be to connect multiple ADCs to one clock line and read the ADCs synchronous.</p>
<h1><a class="anchor" id="description_ADC"></a>
Description of the ADC (CS1237)</h1>
<p>The gain (1,2,64,128), the sample rate(10Hz,40Hz,640Hz,1280Hz), the reference voltage (internal, or external) and the channel(external diferential signal, temperature sensor) of the ADC can be independent configured. The interface of the ADC chip has a unidirectional clock line “CLK” and a bidirectional data line "DOUT/DIN". The clock- line is used for the clock signal and for switching the chip on and off (sleep mode). The data line is used on the one hand to transmit the AD measurement and on the other hand to configure the chip. In addition, an interrupt signal is outputted via the data line for 26,13 us, if a new measurement is available, depending on the configured measurement frequency. The interrupt of the ADC is also outputed during digital data transmission. It must therefore be ensured, that the data transmission is completed at this point, otherwise the result will be incorrect. In the following image a oscilloscope capture of the finished library and three datatransmission processes with the interrupts of the ADC chip can be seen:</p>
<p><img src="..\images\Oszi_measurement.jpg" alt="circuit_diagram couldn't be load!" style="width:100%;" class="inline"/> Diagramm of an oscilloscope measurement while a data transmission process</p>
<h1><a class="anchor" id="description_library"></a>
Description of the setup, the code and the attemps to get it working</h1>
<p>The library is written in Visual Studio Code in C++. For flashing the ESP32 the Arduino extension from Microsoft was used.</p>
<p>My first idea was to connect several chips to one clock line in order to save GPIOs. Unfortunately, after several attempts, this was impossible because the internal clock of the chips are not synchronized and the output interrupt occurrs at different times. This is particularly critical with the desired output frequency of 1280 Hz. That's why I decided to write a C ++ library, in which several instances with different clock lines can be created. The number of ADCs to connect to one MCU is limited to two. The reason is, that the timing is critical especially, when the sample rate is set to 1280. The library could be written to allow more than two instances running in parallel, if the high sample rates are blocked, but that is a future work.</p>
<p>This current library is written with hardware and timer interrupt service routines, so it can run in the background, while the main code is running. And the last measured analog value, which is updated in the background, can be called up anytime. In the next picture you can see a screenshot of the Arduino-Serial-Plotter, while the example code runs on the ESP32 with two ADCs. There is some noise in the signal. This is probably due to the long unshielded cables or due to the PCB layout. The signal is periodic so, in a future work it could be filtered with fourier transformation: The setup can be seen in the next picture. For the differential analog signal were two 10kg loadcells used one is screwed in the negativ and the other in the positive direction to show, that the ADC-library woks in both directions:</p>
<p><img src="..\images\serial_plotter.png" alt="serial_plotter image couldn't be load!" style="width:100%;" class="inline"/> <br  />
 A screenshot of the serial plotter, while the example code runs on the ESP32 with two ADCs</p>
<p><img src="..\images\test_setup_schematic.svg" alt="schematic_back couldn't be load!" style="pointer-events: none; width:100%;" class="inline"/> A schematic sketch to show the test setup </p><div> <img src="..\images\test_setup.jpg" alt="circuit_diagram couldn't be load!" style="width:49%;" title="Bildbeschreibung" class="inline"/> <img src="..\images\3D_printed_scale_with_loadcell.jpg" alt="3D_printed_scale_with_loadcell couldn't be load!" style="width:49%;" class="inline"/> </div><p> fotos of the test setup with the two scales, the loadcells, the ADCs and the NodeMCU</p>
<p>The next picture shows the block diagram of the example code. The detailed describtions and graphs of the class functions are showed on the class page. <img src="..\images\block_diagram_of_example_code.svg" alt="block diagram of the example code couldn't be load!" style="pointer-events: none; width:99%;" class="inline"/> block diagram of the example code</p>
<h1><a class="anchor" id="dependencies"></a>
Dependencies</h1>
<p>This library was only tested on the ESP32 DEV_KIT_V4</p>
<ul>
<li>At this time it is only allowed to connect two ADCs with one clock and one data line each.</li>
<li>you could use nearly any GPIO for the clock lines and any GPIO with an interrupt function for the Data line.</li>
<li>to the ADC were two 10kg loadcells connected.</li>
</ul>
<h1><a class="anchor" id="author"></a>
Author</h1>
<p>Written by Julian Weidinger (matriculation-number : 11259117) for an university Project at the University of applied science.</p>
<p>The source code and one example is available on <a href="https://github.com/JulianWeidinger/CS1237_ADC_Library">my github page</a></p>
<p>The code is written with doxygen comments to create a html documentation of the library. The style is from the doxygen <a href="https://learn.adafruit.com/the-well-automated-arduino-library/doxygen-tips">manuel from Ardafruit</a></p>
<h1><a class="anchor" id="sources"></a>
Sources</h1>
<ol type="1">
<li>datasheet: <a href="https://github.com/rafaellcoellho/cs1237-datasheet/blob/master/cs1237_datasheet.pdf">https://github.com/rafaellcoellho/cs1237-datasheet/blob/master/cs1237_datasheet.pdf</a></li>
<li>external hardware interrupt: <a href="https://techtutorialsx.com/2017/09/30/esp32-arduino-external-interrupts/">https://techtutorialsx.com/2017/09/30/esp32-arduino-external-interrupts/</a></li>
<li>timer interrupts: <a href="https://techtutorialsx.com/2017/10/07/esp32-arduino-timer-interrupts/">https://techtutorialsx.com/2017/10/07/esp32-arduino-timer-interrupts/</a></li>
<li>attach interrupts to class instances: <a href="https://arduinoplusplus.wordpress.com/2021/02/05/interrupts-and-c-class-instances/">https://arduinoplusplus.wordpress.com/2021/02/05/interrupts-and-c-class-instances/</a></li>
<li>doxygen documentation guide: <a href="https://learn.adafruit.com/the-well-automated-arduino-library/doxygen-tips">https://learn.adafruit.com/the-well-automated-arduino-library/doxygen-tips</a></li>
</ol>
<dl class="section date"><dt>Date</dt><dd>09.01.2022 <br  />
 <br  />
</dd></dl>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
